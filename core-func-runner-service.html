<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Ice by goosman-lei</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
	<div class="body">
        <div class="left">
            
            <ul class="menus">
                <li class="title">Ice Framework</li>
                <li>
                    序言
                    <ul>
                        <li><a href="https://github.com/goosman-lei/ice/zipball/master" target="_blank">.zip下载</a></li>
                        <li><a href="https://github.com/goosman-lei/ice/tarball/master" target="_blank">.tar.gz下载</a></li>
                        <li><a href="https://github.com/goosman-lei/ice" target="_blank">Github项目地址</a></li>
                    </ul>
                </li>
                <li>
                    文档
                    <ul>
                        <li><a href="/ice/arch.html">整体架构</a></li>
                        <li>
                            核心功能
                            <ul>
                                <li>
                                <li>
                                    <a href="/ice/core-func-runner.html">运行方式</a>
                                    <ul>
                                        <li><a href="/ice/core-func-runner-web.html">Web</a></li>
                                        <li><a href="/ice/core-func-runner-service.html">Service</a></li>
                                        <li><a href="/ice/core-func-runner-daemon.html">Daemon</a></li>
                                        <li><a href="/ice/core-func-runner-embeded.html">Embeded</a></li>
                                    </ul>
                                </li>
                                <li><a href="/ice/core-func-input-output.html">交互数据</a></li>
                                <li><a href="/ice/core-func-resource.html">资源管理</a></li>
                                <li><a href="/ice/core-func-filter.html">过滤器</a></li>
                                <li><a href="/ice/core-func-feature.html">Feature机制</a></li>
                                <li><a href="/ice/core-func-logger.html">日志处理</a></li>
                                <li><a href="/ice/core-func-db.html">DB查询工具</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    规范
                    <ul>
                        <li><a href="/ice/specification-name.html">命名规范</a></li>
                        <li><a href="/ice/specification-develop.html">开发规范</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="right">

<h1>Service运行方式</h1>

<p><img src="https://raw.githubusercontent.com/goosman-lei/ice/master/doc/resource/images/0006.ice-core-func-runner-service.png" alt="Service应用结构图" /></p>

<h2>Service</h2>

<p>Service作为service运行方式的程序入口.</p>

<p>代码目录为: src/service/<class>.php</p>

<p>Service需要继承\FS_Service. 路由调度会自动执行<class>的<action>方法.</p>

<h2>设计思路</h2>

<p>Ice看中服务的逻辑解耦, 部署方面认为是可接受混部的.</p>

<p>理由: 逻辑解耦的服务, 在资源不足或可用性考虑, 需要部署隔离时, 切换是低成本的.</p>

<p>在这个基础之上, 使用Ice开发的Service, 就期望可以做到以下两点:</p>

<ul>
<li><p>本地调用逻辑解耦的服务, 需要隔离的上下文.</p></li>
<li><p>远程调用和本地调用切换对应用透明</p></li>
</ul>


<h2>实现方式</h2>

<h5>第一点, 隔离的上下文, 得益于php的名字空间.</h5>

<ul>
<li><p>规范层面, 强制要求基于Ice开发的每个项目, 有一个唯一的名字<PROJECT_GROUP>/<PROJECT_NAME>来表示, 以此保证没有名字冲突.</p></li>
<li><p>机制层面, 每个项目, 在Ice中运行时, 都有一个App对象表示它, 这个对象持有这个项目相关的资源, 一切项目特定的操作/配置获取等, 都通过这个App对象展开.</p></li>
</ul>


<p>通过上面两层的限定, Ice中的每个项目, 就有了独立的上下文环境.</p>

<p>多个项目同时运行时, 启动时的主App是有特殊含义的. 比如: 日志记录方式可能需要由主应用来决定.</p>

<p>因此, 在\F_Ice::$ins框架主对象中, 提供了两个App对象的引用</p>

<ul>
<li><p>\F_Ice::$ins->mainApp: 代表入口的主项目</p></li>
<li><p>\F_Ice::$ins->workApp: 代表当前运行的项目</p></li>
</ul>


<h5>第二点, 远程调用和本地调用的透明切换, 是通过一个proxy层来屏蔽细节的.</h5>

<p>业务上需要使用其他服务时, 都是通过proxy_service的get方法, 得到服务的代理对象.</p>

<p>get()方法的第一个参数, 对应src/conf/service.php中的配置, 第二个参数, 指代服务的class名.</p>

<p>下面是服务配置及应用的示例代码</p>

<p>配置文件路径: src/conf/service.php</p>

<pre><code class="php">$pool = array(
    'demo-local' =&gt; array(
        'proxy'  =&gt; 'local',
        'config' =&gt; array(
            'project_group' =&gt; 'ice',
            'project_name'  =&gt; 'demo_service',
        ),
    ),
    'demo-remote' =&gt; array(
        'proxy'  =&gt; 'remote',
        'config' =&gt; array(
            'resource' =&gt; 'curl://service',
        ),
    ),
);

Service调用有三种方式(下面代码是嘉定在action中调用/say/hi服务):

$this-&gt;ice-&gt;mainApp-&gt;proxy_service-&gt;get('internal', 'Say')-&gt;hi();
$this-&gt;ice-&gt;mainApp-&gt;proxy_service-&gt;get('demo-local', 'Say')-&gt;hi();
$this-&gt;ice-&gt;mainApp-&gt;proxy_service-&gt;get('demo-remote', 'Say')-&gt;hi();


其中:
internal是保留字, 表示调用当前app内部的service.

另外两种方式(demo-local, demo-remote), 分别对应了src/conf/service.php中的两个配置

demo-local:
    'demo-local' =&gt; array(
        'proxy'  =&gt; 'local',
        'config' =&gt; array(
            'project_group' =&gt; 'ice',
            'project_name'  =&gt; 'demo_service',
        ),
    ),
proxy = local 用来说明此项目是本地部署(composer依赖)
config中指明了项目的GROUP和NAME, 框架会自动对应到vender/ice/demo_service去加载服务

demo-remote:
    'demo-remote' =&gt; array(
        'proxy'  =&gt; 'remote',
        'config' =&gt; array(
            'resource' =&gt; 'curl://service',
        ),
    ),
proxy = remote 用来说明此服务是远程部署, 通过HTTP WebService调用方式使用服务
$config中指明了服务对应的资源(参考src/conf/resource.php). 框架会自动使用资源管理器, 获取对应资源并请求服务.
</code></pre>

      </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
