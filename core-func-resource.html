<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Ice by goosman-lei</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Ice</h1>
        <p class="header">Ice framework for (php) web development</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/goosman-lei/ice/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/goosman-lei/ice/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/goosman-lei/ice">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/goosman-lei">goosman-lei</a></p>


      </header>
      <section>

<h1>资源管理</h1>

<p><img src="https://raw.githubusercontent.com/goosman-lei/ice/master/doc/resource/images/0007.ice-core-func-resource.png" alt="资源管理模块设计图" /></p>

<h2>设计思路</h2>

<p>设计思路, 主要基于下面的思考</p>

<ul>
<li><p>任何面向连接的资源访问, 均可抽象两个步骤组成: 连接(含授权), 命令.(忽略关闭连接, 语言层面已经解决)</p></li>
<li><p>对资源的管理, 比如熔断, 降级等, 是通用策略, 并且通常是应用在连接层面. (某些场景命令层面可提供数据)</p></li>
<li><p>基于此, Ice将一个资源拆分为Connector和Handler两部分. 并在外层增加一个proxy调度层, 用作对资源的调度管理.</p></li>
</ul>


<p>Ice中的资源管理, 其价值主要在于分离了资源获取和资源使用两块, 在资源获取阶段, 通过调度层, 可以方便的进行调度管理.</p>

<h2>配置详解</h2>

<pre><code class="php">// scheme到自定义实现的映射. 用于扩展自己的资源处理器
$mapping = array(
    'connector' =&gt; array(
        'redis' =&gt; '\\ice\\demo\\Lib\\RedisConnector',
    ),
    'handler'   =&gt; array(
        'redis' =&gt; '\\ice\\demo\\Lib\\RedisHandler',
    ),
    'strategy'  =&gt; array(),
);

// 资源的获取语法为:
// $proxy-&gt;get(&lt;scheme&gt; "://" &lt;unitname&gt; [ "/" &lt;cluster&gt; ] [ "?force_new=true&amp;algo=random" ]
// scheme定义了资源类型
// unitname定义了业务单元.
// cluster定义了不同的集群. 比如mysql的主从
// QueryString中定义了两个选项:
//      algo=random: 用来指定调度策略. 内部仅实现了random
//      force_new=true: 指定强制获取新的资源

// 资源的配置结构, 是一个多层次结构: scheme &gt; unitname &gt; cluster &gt; node
// 最小单元就是节点(node). 下面例子中, 就是 array('host' =&gt; '127.0.0.1', 'port' =&gt; 3306)
//      (调度算法站额对的就是指定集群中, 多个节点的选择策略)
// 配置结构中的options是多级继承的, 每一层都可以有options. 下层会自动继承merge上层的options
$pool = array(
    'mysqli' =&gt; array(
        'options' =&gt; array(
            'deny_empty_update_delete' =&gt; TRUE,
            'warn_sql_length' =&gt; 51200,
            'fatal_sql_length' =&gt; 2097152,
        ),
        'demo' =&gt; array(
            'master' =&gt; array(
                array('host' =&gt; '127.0.0.1', 'port' =&gt; 3306),
            ),
            'slave' =&gt; array(
                array('host' =&gt; '127.0.0.1', 'port' =&gt; 3306),
            ),
            'options' =&gt; array(
                'timeout' =&gt; 1,
                'user'    =&gt; '',
                'passwd'  =&gt; '',
            ),
        ),
    ),
    'curl' =&gt; array(
        'service' =&gt; array(
            'default' =&gt; array(
                array('host' =&gt; 'service.host.com') // 修改为service的host
            ),
        ),
    ),
);
</code></pre>

<h2>应用示例</h2>

<pre><code class="php">$facebookCurl = \F_Ice::$ins-&gt;workApp-&gt;proxy_resource-&gt;get('curl://facebook-page');
$wechatCurl   = \F_Ice::$ins-&gt;workApp-&gt;proxy_resource-&gt;get('curl://wechat');
$userMysql    = \F_Ice::$ins-&gt;workApp-&gt;proxy_resource-&gt;get('mysqli://user/master');

$facebookCurl-&gt;get('/');
$wechatCurl-&gt;get('/');
$userMysql-&gt;query('SHOW TABLES');
</code></pre>

      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
