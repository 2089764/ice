<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Ice by goosman-lei</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/github-light.css">
    <script src="/javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
	<div class="body">
        <div class="left">
            
            <ul class="menus">
                <li class="title">Ice Framework</li>
                <li>
                    项目
                    <ul>
                        <li><a href="https://github.com/goosman-lei/ice" target="_blank">Github项目地址</a></li>
                        <li><a href="https://github.com/goosman-lei/ice/zipball/master" target="_blank">.zip下载</a></li>
                        <li><a href="https://github.com/goosman-lei/ice/tarball/master" target="_blank">.tar.gz下载</a></li>
                    </ul>
                </li>
                <li>
                    文档
                    <ul>
                        <li><a href="/ice/index.html">首页</a></li>
                        <li><a href="/ice/arch.html">整体架构</a></li>
                        <li>
                            核心功能
                            <ul>
                                <li>
                                <li>
                                    <a href="/ice/core-func-runner.html">运行方式</a>
                                    <ul>
                                        <li><a href="/ice/core-func-runner-web.html">Web</a></li>
                                        <li><a href="/ice/core-func-runner-service.html">Service</a></li>
                                        <li><a href="/ice/core-func-runner-daemon.html">Daemon</a></li>
                                        <li><a href="/ice/core-func-runner-embeded.html">Embeded</a></li>
                                    </ul>
                                </li>
                                <li><a href="/ice/core-func-input-output.html">交互数据</a></li>
                                <li><a href="/ice/core-func-resource.html">资源管理</a></li>
                                <li><a href="/ice/core-func-filter.html">过滤器</a></li>
                                <li><a href="/ice/core-func-feature.html">Feature机制</a></li>
                                <li><a href="/ice/core-func-logger.html">日志处理</a></li>
                                <li><a href="/ice/core-func-db.html">DB查询工具</a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    规范
                    <ul>
                        <li><a href="/ice/specification-name.html">命名规范</a></li>
                        <li><a href="/ice/specification-develop.html">开发规范</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="right">

<h1>Feature组件</h1>

<p>Feature组件是一个实现简单, 应用简单, 但在App的API开发中, 针对版本差异性开发, 非常有用的工具.</p>

<h2>Feature组件的设计思路</h2>

<p>Feature组件的设计思路, 源自C语言预编译中的宏设计.</p>

<p>在C语言中, 很多时候, 需要基于一些宏的限定条件, 执行响应的逻辑</p>

<p>比如, 下面代码摘自PHP内核中php_request_startup()函数的实现:</p>

<pre><code class="c">#ifdef HAVE_DTRACE
    DTRACE_REQUEST_STARTUP(SAFE_FILENAME(SG(request_info).path_translated), SAFE_FILENAME(SG(request_info).request_uri), (char *)SAFE_FILENAME(SG(request_info).request_method));
#endif /* HAVE_DTRACE */

#ifdef PHP_WIN32
    PG(com_initialized) = 0; 
#endif

#if PHP_SIGCHILD
    signal(SIGCHLD, sigchld_handler);
#endif

每一种宏, 代表了一种场景, 在符合场景要求时, 对应的代码才生效
</code></pre>

<p>Ice中的Feature就是借鉴这个思想而来的.</p>

<h2>Ice中的Feature应用</h2>

<p>和C语言中的宏的使用非常相似.</p>

<pre><code class="php">// 如果是ios 9以上版本, 差异性逻辑
if ($this-&gt;feature-&gt;isEnable('ge-ios-9')) {
    // ...
}

// 如果是baidu渠道3.2以上版本, 差异性逻辑
if ($this-&gt;feature-&gt;isEnable('baidu-ge-3.2')) {
    // ...
}
</code></pre>

<h2>Ice中Feature的配置</h2>

<p>上面给出了Feature在应用逻辑编写时候的示例.</p>

<p>那ge-ios-9, baidu-ge-3.2这些名字(feature)是哪来的呢?</p>

<p>只需要在src/conf/feature.php中增加配置即可.</p>

<pre><code class="php">&lt;?php
$config = array(
    '*' =&gt; array(
        'ge-ios-9' =&gt; array(
            'osName eq ios',
            'osVersion v&gt;= 9.0',
        ),
        'baidu-ge-3.2' =&gt; array(
            'channel eq baidu',
            'osName eq android',
            'appVersion v&gt;= 3.2',
        ),
    ),
    '/say/hello' =&gt; array(),
);

Feature的配置, 是可以限定URI的(/controller/action), 限定URI, 则仅访问对应URI才会生效, 否则, 放在'*'下的, 对所有请求都生效.
</code></pre>

<p>Ok. 上面就是Feature的配置. 那配置中的osName, osVersion等是哪里来的呢?</p>

<p>Ice中将输入输出数据抽象为四种: ClientEnv, ServerEnv, Request, Response. 其中, ClientEnv就代表了客户端的环境.</p>

<p>而ClientEnv的实现是开放的, 你可以随时往ClientEnv上添加数据.</p>

<pre><code class="php">\F_Ice::$ins-&gt;runner-&gt;clientEnv-&gt;osName = \F_Ice::$ins-&gt;runner-&gt;request-&gt;getQuery('osn');
\F_Ice::$ins-&gt;runner-&gt;clientEnv-&gt;osVersion = \F_Ice::$ins-&gt;runner-&gt;request-&gt;getQuery('osv');
...
</code></pre>

<p>在系统初始化阶段, 应用上统一的将客户端环境信息设置到ClientEnv中, 这样, 就拥有了一套基于客户端环境, 灵活的做差异性逻辑处理的Feature机制.</p>

      </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
